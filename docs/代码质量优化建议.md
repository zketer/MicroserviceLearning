# ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§ä¼˜åŒ–å»ºè®®

## ğŸ¯ æ¦‚è¿°

è™½ç„¶å½“å‰é¡¹ç›®ä»£ç æ²¡æœ‰è¯Šæ–­é—®é¢˜ï¼Œä½†ä¸ºäº†è¿›ä¸€æ­¥æå‡ä»£ç è´¨é‡ã€å¯ç»´æŠ¤æ€§å’Œç”Ÿäº§ç¯å¢ƒé€‚ç”¨æ€§ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚

## ğŸ“‹ ä»£ç è´¨é‡ä¼˜åŒ–

### 1. å¼‚å¸¸å¤„ç†å¢å¼º

#### å½“å‰çŠ¶æ€
```java
// å½“å‰çš„ç®€å•å¼‚å¸¸å¤„ç†
public Result<User> register(User user) {
    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    if (userMapper.findByUsername(user.getUsername()) != null) {
        return Result.error("ç”¨æˆ·åå·²å­˜åœ¨");
    }
    // ...
}
```

#### å»ºè®®ä¼˜åŒ–
```java
// 1. åˆ›å»ºè‡ªå®šä¹‰å¼‚å¸¸ç±»
public class BusinessException extends RuntimeException {
    private String code;
    private String message;
    
    public BusinessException(String code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
}

// 2. åˆ›å»ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        log.error("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
        return Result.error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        return Result.error("SYSTEM_ERROR", "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
}

// 3. ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘
public Result<User> register(User user) {
    if (userMapper.findByUsername(user.getUsername()) != null) {
        throw new BusinessException("USER_EXISTS", "ç”¨æˆ·åå·²å­˜åœ¨");
    }
    // ...
}
```

### 2. å‚æ•°éªŒè¯å¢å¼º

#### å»ºè®®æ·»åŠ 
```java
// 1. åœ¨å®ä½“ç±»ä¸­æ·»åŠ éªŒè¯æ³¨è§£
public class User {
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Length(min = 3, max = 20, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´")
    private String username;
    
    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Length(min = 6, max = 20, message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä¸ªå­—ç¬¦ä¹‹é—´")
    private String password;
    
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;
    
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®")
    private String phone;
}

// 2. åœ¨Controllerä¸­å¯ç”¨éªŒè¯
@PostMapping("/register")
public Result<User> register(@Valid @RequestBody User user) {
    return userService.register(user);
}
```

### 3. æ—¥å¿—è®°å½•ä¼˜åŒ–

#### å»ºè®®æ·»åŠ 
```java
// 1. ç»Ÿä¸€æ—¥å¿—æ ¼å¼
@Slf4j
@Service
public class UserService {
    
    public Result<User> register(User user) {
        log.info("ç”¨æˆ·æ³¨å†Œå¼€å§‹, username: {}", user.getUsername());
        
        try {
            // ä¸šåŠ¡é€»è¾‘
            User savedUser = userMapper.insert(user);
            log.info("ç”¨æˆ·æ³¨å†ŒæˆåŠŸ, userId: {}, username: {}", 
                    savedUser.getId(), savedUser.getUsername());
            return Result.success(savedUser);
        } catch (Exception e) {
            log.error("ç”¨æˆ·æ³¨å†Œå¤±è´¥, username: {}, error: {}", 
                     user.getUsername(), e.getMessage(), e);
            throw e;
        }
    }
}

// 2. æ·»åŠ è¯·æ±‚æ—¥å¿—æ‹¦æˆªå™¨
@Component
public class LoggingInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        String requestId = UUID.randomUUID().toString();
        MDC.put("requestId", requestId);
        log.info("è¯·æ±‚å¼€å§‹: {} {}, requestId: {}", 
                request.getMethod(), request.getRequestURI(), requestId);
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                              HttpServletResponse response, 
                              Object handler, Exception ex) {
        log.info("è¯·æ±‚ç»“æŸ: {} {}, status: {}", 
                request.getMethod(), request.getRequestURI(), response.getStatus());
        MDC.clear();
    }
}
```

## ğŸ”§ æ¶æ„ä¼˜åŒ–å»ºè®®

### 1. é…ç½®ç®¡ç†ä¼˜åŒ–

#### å»ºè®®æ·»åŠ é…ç½®ä¸­å¿ƒ
```yaml
# æ·»åŠ Spring Cloud Config
spring:
  cloud:
    config:
      uri: http://localhost:8888
      profile: dev
      label: master
```

#### ç¯å¢ƒé…ç½®åˆ†ç¦»
```yaml
# application-dev.yml (å¼€å‘ç¯å¢ƒ)
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/springcloud_study_dev
    
# application-prod.yml (ç”Ÿäº§ç¯å¢ƒ)
spring:
  datasource:
    url: jdbc:mysql://prod-db:3306/springcloud_study
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
```

### 2. å®‰å…¨æ€§å¢å¼º

#### å»ºè®®æ·»åŠ 
```java
// 1. JWTè®¤è¯
@Component
public class JwtTokenUtil {
    
    private String secret = "mySecret";
    private int expiration = 3600;
    
    public String generateToken(String username) {
        return Jwts.builder()
                .setSubject(username)
                .setExpiration(new Date(System.currentTimeMillis() + expiration * 1000))
                .signWith(SignatureAlgorithm.HS512, secret)
                .compact();
    }
    
    public boolean validateToken(String token, String username) {
        return username.equals(getUsernameFromToken(token)) && !isTokenExpired(token);
    }
}

// 2. å¯†ç åŠ å¯†
@Service
public class UserService {
    
    @Resource
    private PasswordEncoder passwordEncoder;
    
    public Result<User> register(User user) {
        // å¯†ç åŠ å¯†
        user.setPassword(passwordEncoder.encode(user.getPassword()));
        // ...
    }
}
```

### 3. ç¼“å­˜ç­–ç•¥

#### å»ºè®®æ·»åŠ Redisç¼“å­˜
```java
// 1. æ·»åŠ ç¼“å­˜é…ç½®
@EnableCaching
@Configuration
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory factory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(10))
                .serializeKeysWith(RedisSerializationContext.SerializationPair
                        .fromSerializer(new StringRedisSerializer()))
                .serializeValuesWith(RedisSerializationContext.SerializationPair
                        .fromSerializer(new GenericJackson2JsonRedisSerializer()));
        
        return RedisCacheManager.builder(factory)
                .cacheDefaults(config)
                .build();
    }
}

// 2. åœ¨æœåŠ¡ä¸­ä½¿ç”¨ç¼“å­˜
@Service
public class UserService {
    
    @Cacheable(value = "users", key = "#id")
    public Result<User> getUserById(Long id) {
        User user = userMapper.selectById(id);
        return Result.success(user);
    }
    
    @CacheEvict(value = "users", key = "#user.id")
    public Result<User> updateUser(User user) {
        userMapper.updateById(user);
        return Result.success(user);
    }
}
```

## ğŸ“Š ç›‘æ§å’Œè¿ç»´ä¼˜åŒ–

### 1. å¥åº·æ£€æŸ¥å¢å¼º

```java
// è‡ªå®šä¹‰å¥åº·æ£€æŸ¥
@Component
public class DatabaseHealthIndicator implements HealthIndicator {
    
    @Resource
    private UserMapper userMapper;
    
    @Override
    public Health health() {
        try {
            userMapper.selectCount(null);
            return Health.up()
                    .withDetail("database", "Available")
                    .build();
        } catch (Exception e) {
            return Health.down()
                    .withDetail("database", "Unavailable")
                    .withException(e)
                    .build();
        }
    }
}
```

### 2. æŒ‡æ ‡ç›‘æ§

```yaml
# æ·»åŠ Micrometerç›‘æ§
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
```

### 3. é“¾è·¯è¿½è¸ª

```yaml
# æ·»åŠ Sleuthé“¾è·¯è¿½è¸ª
spring:
  sleuth:
    sampler:
      probability: 1.0
    zipkin:
      base-url: http://localhost:9411
```

## ğŸ§ª æµ‹è¯•ä¼˜åŒ–

### 1. å•å…ƒæµ‹è¯•å¢å¼º

```java
// æœåŠ¡å±‚æµ‹è¯•
@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserMapper userMapper;
    
    @InjectMocks
    private UserService userService;
    
    @Test
    void testRegister_Success() {
        // Given
        User user = new User();
        user.setUsername("testuser");
        user.setPassword("password");
        
        when(userMapper.findByUsername("testuser")).thenReturn(null);
        when(userMapper.insert(any(User.class))).thenReturn(1);
        
        // When
        Result<User> result = userService.register(user);
        
        // Then
        assertThat(result.isSuccess()).isTrue();
        verify(userMapper).insert(any(User.class));
    }
}

// é›†æˆæµ‹è¯•
@SpringBootTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
@Testcontainers
class UserServiceIntegrationTest {
    
    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
            .withDatabaseName("test")
            .withUsername("test")
            .withPassword("test");
    
    @Autowired
    private UserService userService;
    
    @Test
    void testRegisterAndLogin() {
        // æµ‹è¯•ç”¨æˆ·æ³¨å†Œå’Œç™»å½•æµç¨‹
    }
}
```

### 2. APIæµ‹è¯•è‡ªåŠ¨åŒ–

```java
// ä½¿ç”¨TestRestTemplateè¿›è¡ŒAPIæµ‹è¯•
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class UserControllerIntegrationTest {
    
    @Resource
    private TestRestTemplate restTemplate;
    
    @Test
    void testUserRegistration() {
        User user = new User();
        user.setUsername("testuser");
        user.setPassword("password");
        
        ResponseEntity<Result> response = restTemplate.postForEntity(
                "/user/register", user, Result.class);
        
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody().isSuccess()).isTrue();
    }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_user_username ON user(username);
CREATE INDEX idx_user_email ON user(email);
CREATE INDEX idx_order_user_id ON orders(user_id);
CREATE INDEX idx_order_status ON orders(status);

-- åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
SELECT * FROM orders 
WHERE user_id = ? 
ORDER BY create_time DESC 
LIMIT ?, ?;
```

### 2. è¿æ¥æ± ä¼˜åŒ–

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 300000
      max-lifetime: 1800000
      connection-timeout: 30000
      validation-timeout: 5000
      leak-detection-threshold: 60000
```

### 3. JVMä¼˜åŒ–

```bash
# å¯åŠ¨å‚æ•°ä¼˜åŒ–
java -Xms512m -Xmx1024m \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:+HeapDumpOnOutOfMemoryError \
     -XX:HeapDumpPath=/logs/heapdump.hprof \
     -jar app.jar
```

## ğŸ“š ä¾èµ–ç®¡ç†å’Œç‰ˆæœ¬å…¼å®¹æ€§

### 1. ä¾èµ–ç‰ˆæœ¬ç®¡ç†

```xml
<!-- åœ¨çˆ¶pom.xmlä¸­é›†ä¸­ç®¡ç†ä¾èµ–ç‰ˆæœ¬ -->
<properties>
    <java.version>17</java.version>
    <spring-boot.version>3.2.5</spring-boot.version>
    <spring-cloud.version>2023.0.0</spring-cloud.version>
    <mybatis-plus.version>3.5.7</mybatis-plus.version>
    <mysql.version>8.0.33</mysql.version>
</properties>

<dependencyManagement>
    <dependencies>
        <!-- Spring Boot -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>${spring-boot.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        
        <!-- Spring Cloud -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${spring-cloud.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        
        <!-- MyBatis Plus -->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-spring-boot3-starter</artifactId>
            <version>${mybatis-plus.version}</version>
        </dependency>
    </dependencies>
</dependencyManagement>
```

### 2. ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥

#### å»ºè®®æ·»åŠ ä¾èµ–åˆ†ææ’ä»¶
```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-dependency-plugin</artifactId>
    <version>3.6.0</version>
    <executions>
        <execution>
            <id>analyze</id>
            <goals>
                <goal>analyze</goal>
            </goals>
            <configuration>
                <failOnWarning>true</failOnWarning>
            </configuration>
        </execution>
    </executions>
</plugin>
```

### 3. æ¡†æ¶å‡çº§ç­–ç•¥

#### Spring Boot 3.xå‡çº§æ³¨æ„äº‹é¡¹
- Java 17+æ˜¯å¿…éœ€çš„
- ä½¿ç”¨Jakarta EE 9+ï¼ˆjavaxåŒ…åå˜æ›´ä¸ºjakartaï¼‰
- æ£€æŸ¥æ‰€æœ‰ä¾èµ–çš„å…¼å®¹æ€§
- ä½¿ç”¨ä¸“ä¸ºSpring Boot 3è®¾è®¡çš„starter

#### MyBatis Plusä¸Spring Boot 3.2.xå…¼å®¹æ€§
- ä½¿ç”¨`mybatis-plus-spring-boot3-starter`æ›¿ä»£`mybatis-plus-boot-starter`
- ç¡®ä¿MyBatis Plusç‰ˆæœ¬ä¸º3.5.7æˆ–æ›´é«˜ç‰ˆæœ¬
- æ³¨æ„Spring Boot 3.2.xå¯¹`FactoryBeanRegistrySupport.getTypeForFactoryBeanFromAttributes()`æ–¹æ³•çš„æ›´æ”¹

## ğŸ“¦ éƒ¨ç½²ä¼˜åŒ–

### 1. DockeråŒ–

```dockerfile
# Dockerfile
FROM openjdk:17-jre-alpine

VOLUME /tmp

COPY target/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "/app.jar"]
```

### 2. Docker Compose

```yaml
# docker-compose.yml
version: '3.8'
services:
  eureka-server:
    build: ../eureka-server
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker

  user-service:
    build: ../user-service
    ports:
      - "8081:8081"
    depends_on:
      - eureka-server
      - mysql
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-server:8761/eureka

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=springcloud_study
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql

volumes:
  mysql_data:
```

## ğŸ“‹ ä»£ç è§„èŒƒ

### 1. ä»£ç æ ¼å¼åŒ–

```xml
<!-- æ·»åŠ åˆ°pom.xml -->
<plugin>
    <groupId>com.spotify.fmt</groupId>
    <artifactId>fmt-maven-plugin</artifactId>
    <version>2.19</version>
    <executions>
        <execution>
            <goals>
                <goal>format</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

### 2. é™æ€ä»£ç åˆ†æ

```xml
<!-- SonarQubeæ’ä»¶ -->
<plugin>
    <groupId>org.sonarsource.scanner.maven</groupId>
    <artifactId>sonar-maven-plugin</artifactId>
    <version>3.9.1.2184</version>
</plugin>

<!-- SpotBugsæ’ä»¶ -->
<plugin>
    <groupId>com.github.spotbugs</groupId>
    <artifactId>spotbugs-maven-plugin</artifactId>
    <version>4.7.1.1</version>
</plugin>
```

## ğŸ¯ å®æ–½å»ºè®®

### ä¼˜å…ˆçº§æ’åº

1. **é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰**
   - å¼‚å¸¸å¤„ç†å¢å¼º
   - å‚æ•°éªŒè¯
   - æ—¥å¿—è®°å½•ä¼˜åŒ–
   - åŸºç¡€å•å…ƒæµ‹è¯•

2. **ä¸­ä¼˜å…ˆçº§ï¼ˆçŸ­æœŸå®æ–½ï¼‰**
   - ç¼“å­˜ç­–ç•¥
   - å®‰å…¨æ€§å¢å¼º
   - å¥åº·æ£€æŸ¥
   - æ•°æ®åº“ä¼˜åŒ–

3. **ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸè§„åˆ’ï¼‰**
   - é…ç½®ä¸­å¿ƒ
   - é“¾è·¯è¿½è¸ª
   - DockeråŒ–éƒ¨ç½²
   - æ€§èƒ½ç›‘æ§

### å®æ–½æ­¥éª¤

1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šå®Œå–„åŸºç¡€åŠŸèƒ½ï¼ˆå¼‚å¸¸å¤„ç†ã€éªŒè¯ã€æ—¥å¿—ï¼‰
2. **ç¬¬äºŒé˜¶æ®µ**ï¼šå¢å¼ºç³»ç»Ÿç¨³å®šæ€§ï¼ˆç¼“å­˜ã€å®‰å…¨ã€ç›‘æ§ï¼‰
3. **ç¬¬ä¸‰é˜¶æ®µ**ï¼šä¼˜åŒ–éƒ¨ç½²è¿ç»´ï¼ˆå®¹å™¨åŒ–ã€è‡ªåŠ¨åŒ–ï¼‰
4. **ç¬¬å››é˜¶æ®µ**ï¼šå®Œå–„æµ‹è¯•ä½“ç³»ï¼ˆè‡ªåŠ¨åŒ–æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ï¼‰

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–å»ºè®®çš„é€æ­¥å®æ–½ï¼Œå¯ä»¥æ˜¾è‘—æå‡é¡¹ç›®çš„ä»£ç è´¨é‡ã€å¯ç»´æŠ¤æ€§å’Œç”Ÿäº§ç¯å¢ƒé€‚ç”¨æ€§ã€‚å»ºè®®æ ¹æ®å®é™…éœ€æ±‚å’Œå›¢é˜Ÿæƒ…å†µï¼Œæœ‰é€‰æ‹©æ€§åœ°å®æ–½è¿™äº›ä¼˜åŒ–æªæ–½ã€‚